<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>T√≠nh s·ªë t·ªù & ti·ªÅn in PDF</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">

  <div class="bg-white shadow-xl rounded-2xl p-6 max-w-6xl mx-auto">
    <h2 class="text-3xl font-bold mb-6 text-center text-blue-600">üìë T√≠nh s·ªë t·ªù & ti·ªÅn in PDF</h2>
    
    <!-- Upload -->
    <div class="grid sm:grid-cols-2 gap-6 mb-6">
      <label>
        <span class="text-gray-700 font-medium">Ch·ªçn file PDF</span>
        <input type="file" id="fileInput" multiple accept=".pdf"
               class="mt-2 block w-full text-sm text-gray-600 
                      file:mr-4 file:py-2 file:px-4
                      file:rounded-xl file:border-0
                      file:text-sm file:font-semibold
                      file:bg-blue-50 file:text-blue-600
                      hover:file:bg-blue-100 cursor-pointer">
      </label>
      <label>
        <span class="text-gray-700 font-medium">Ho·∫∑c ch·ªçn th∆∞ m·ª•c PDF</span>
        <input type="file" id="folderInput" webkitdirectory directory multiple accept=".pdf"
               class="mt-2 block w-full text-sm text-gray-600 
                      file:mr-4 file:py-2 file:px-4
                      file:rounded-xl file:border-0
                      file:text-sm file:font-semibold
                      file:bg-green-50 file:text-green-600
                      hover:file:bg-green-100 cursor-pointer">
      </label>
    </div>

    <!-- Cards t·ªïng k·∫øt -->
    <div id="summaryCards" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6"></div>

    <!-- B·∫£ng chi ti·∫øt -->
    <div class="overflow-x-auto">
      <table class="w-full border border-gray-200 rounded-lg text-sm text-left">
        <thead class="bg-blue-50 text-blue-700 font-semibold">
          <tr>
            <th class="p-2 border">T√™n file</th>
            <th class="p-2 border text-center">S·ªë trang</th>
            <th class="p-2 border text-center">S·ªë t·ªù</th>
          </tr>
        </thead>
        <tbody id="fileTable" class="text-gray-800"></tbody>
      </table>
    </div>

    <!-- Nh·∫≠p gi√° & t√≠nh -->
    <div class="flex items-center space-x-2 mt-6">
      <input type="number" id="priceInput" placeholder="Nh·∫≠p gi√°/t·ªù" 
             class="border rounded-lg p-2 w-40 text-sm">
      <button id="calcBtn" 
              class="px-4 py-2 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600">
        T√≠nh ti·ªÅn
      </button>
      <button id="exportBtn" 
              class="px-4 py-2 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600 hidden">
        ‚¨áÔ∏è Xu·∫•t Excel
      </button>
    </div>

    <!-- T·ªïng ti·ªÅn -->
    <div id="totalResult" class="mt-3 text-xl font-bold text-green-600"></div>

    <!-- L·ªãch s·ª≠ -->
    <h3 class="text-xl font-bold mt-8 mb-3 text-gray-700">üìú L·ªãch s·ª≠ t√≠nh to√°n</h3>
    <ul id="history" class="list-disc pl-6 space-y-1 text-gray-700 text-sm"></ul>
  </div>

  <script>
    const fileInput = document.getElementById("fileInput");
    const folderInput = document.getElementById("folderInput");
    const fileTable = document.getElementById("fileTable");
    const summaryCards = document.getElementById("summaryCards");
    const priceInput = document.getElementById("priceInput");
    const calcBtn = document.getElementById("calcBtn");
    const exportBtn = document.getElementById("exportBtn");
    const totalResult = document.getElementById("totalResult");
    const history = document.getElementById("history");

    let totalPages = 0;
    let totalSheets = 0;
    let fileCount = 0;
    let details = [];

    function updateSummary() {
      summaryCards.innerHTML = `
        <div class="bg-blue-50 p-4 rounded-xl shadow text-center">
          <div class="text-2xl font-bold text-blue-600">${fileCount}</div>
          <div class="text-gray-700">T·ªïng s·ªë file</div>
        </div>
        <div class="bg-yellow-50 p-4 rounded-xl shadow text-center">
          <div class="text-2xl font-bold text-yellow-600">${totalPages}</div>
          <div class="text-gray-700">T·ªïng s·ªë trang</div>
        </div>
        <div class="bg-green-50 p-4 rounded-xl shadow text-center">
          <div class="text-2xl font-bold text-green-600">${totalSheets}</div>
          <div class="text-gray-700">T·ªïng s·ªë t·ªù</div>
        </div>
      `;
    }

    async function handleFiles(files) {
      fileTable.innerHTML = "";
      details = [];
      totalPages = 0;
      totalSheets = 0;
      fileCount = 0;

      for (let file of files) {
        if (file.type !== "application/pdf") continue;
        let arrayBuffer = await file.arrayBuffer();
        let pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let pages = pdf.numPages;
        let sheets = Math.ceil(pages / 2);

        totalPages += pages;
        totalSheets += sheets;
        fileCount++;

        details.push({
          name: file.webkitRelativePath || file.name,
          pages,
          sheets
        });

        let row = document.createElement("tr");
        row.innerHTML = `
          <td class="p-2 border">${file.webkitRelativePath || file.name}</td>
          <td class="p-2 border text-center">${pages}</td>
          <td class="p-2 border text-center">${sheets}</td>
        `;
        fileTable.appendChild(row);
      }

      updateSummary();
      totalResult.textContent = "";
      exportBtn.classList.add("hidden");
    }

    fileInput.addEventListener("change", e => handleFiles(e.target.files));
    folderInput.addEventListener("change", e => handleFiles(e.target.files));

    calcBtn.addEventListener("click", () => {
      let price = parseFloat(priceInput.value);
      if (isNaN(price) || price <= 0) {
        totalResult.textContent = "‚ö†Ô∏è Nh·∫≠p gi√° h·ª£p l·ªá!";
        totalResult.className = "mt-3 text-xl font-bold text-red-600";
        return;
      }
      let total = totalSheets * price;
      totalResult.textContent = `üí∞ T·ªïng ti·ªÅn: ${total.toLocaleString()} VND`;
      totalResult.className = "mt-3 text-xl font-bold text-green-600";

      // L∆∞u l·ªãch s·ª≠
      let li = document.createElement("li");
      li.textContent = `${fileCount} file, ${totalPages} trang, ${totalSheets} t·ªù √ó ${price} = ${total.toLocaleString()} VND`;
      history.appendChild(li);

      exportBtn.classList.remove("hidden");
    });

    exportBtn.addEventListener("click", () => {
      let wsData = [["T√™n file", "S·ªë trang", "S·ªë t·ªù"]];
      details.forEach(d => wsData.push([d.name, d.pages, d.sheets]));
      wsData.push([]);
      wsData.push(["T·ªïng c·ªông", totalPages, totalSheets]);
      let price = parseFloat(priceInput.value);
      if (!isNaN(price) && price > 0) {
        let total = totalSheets * price;
        wsData.push(["Gi√°/t·ªù", price]);
        wsData.push(["T·ªïng ti·ªÅn", total]);
      }

      let ws = XLSX.utils.aoa_to_sheet(wsData);
      let wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "K·∫øt qu·∫£");
      XLSX.writeFile(wb, "ket_qua_tinh_toan.xlsx");
    });
  </script>
</body>
</html>
